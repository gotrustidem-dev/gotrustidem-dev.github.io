<!DOCTYPE html>
<html>

<head>
    <title>GoTrustIdem TestPKI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://gotrustidem-dev.github.io/utils/cbor.js"></script>
    <script src="https://gotrustidem-dev.github.io/utils/helpers.js"></script>
    <script src="https://gotrustidem-dev.github.io/utils/showMessage.js"></script>
    <script src="https://gotrustidem-dev.github.io/utils/response.js"></script>
    <script src="https://gotrustidem-dev.github.io/utils/PKIoverFIDO.js"></script>
</head>

<body>
    <div style="overflow-x: scroll;">
        <table style="height: auto; width: 100%;">
            <tbody>

                <tr>
                    <td style="width: 100% ;">


                        <form style="text-align: center;" id="form_token_sn" onsubmit="return false">
                            <p>
                                <label id="label_token_sn">Token Serial number:</label><br>
                                <input type="text" name="token_sn" style="width: 342px; height:41px">
                            </p>
                        </form>

                    </td>
                </tr>

                <tr>
                    <td style="width: 100% ; ">
                        <table class="center" border="1" width="100%">
                            <tbody>
                                <tr>
                                    <!--PC side-->
                                    <td style="width: 385px;">

                                        <form style="text-align: center;" id="form_so_pin" onsubmit="return false">
                                            <p>
                                                <label id="label_so_pin"> Old SO PIN:</label><br>
                                                <input type="text" name="so_pin" style="width: 342px; height:41px">
                                            </p>
                                        </form>

                                        <form style="text-align: center;" id="form_new_so_pin" onsubmit="return false">
                                            <p>
                                                <label id="label_new_so_pin"> New SO PIN:</label><br>
                                                <input type="text" name="new_so_pin" style="width: 342px; height:41px">
                                            </p>
                                        </form>

                                        <form style="text-align: center;" id="form_new_user_pin" onsubmit="return false">
                                            <p>
                                                <label id="label_new_user_pin"> New User PIN:</label><br>
                                                <input type="text" name="new_user_pin" style="width: 342px; height:41px">
                                            </p>
                                        </form>

                                        <form style="text-align: center;" id="form_allow_domain" onsubmit="return false">
                                            <p>
                                                <label id="label_allow_domain"> Allow host domain :</label><br>
                                                <input type="text" name="allowrpid1" style="width: 342px; height:41px" value="*.gotrustid.com"><br>
                                                <input type="text" name="allowrpid2" style="width: 342px; height:41px" value="gotrustid.com.tw" ><br>
                                                <input type="text" name="allowrpid3" style="width: 342px; height:41px" value="gotrustidem-dev.github.io" ><br>
                                                <input type="text" name="allowrpid4" style="width: 342px; height:41px" value="ctbc.com" ><br>
                                                <input type="text" name="allowrpid5" style="width: 342px; height:41px" value="ctbc123.com"><br>
                                                <input type="text" name="allowrpid6" style="width: 342px; height:41px" value="test.ctbc.com" ><br>
                                            </p>
                                        </form>
                                        <p>
                                            <form style="text-align: center;" id="form_init_btn"
                                                onsubmit="return false">
                                                <button class="btn btn-primary" action="submit"
                                                    style="width: 200px; height:34px;background-color: #008CBA;">Init Token</button>
                                            </form>
                                        </p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </td>

                </tr>
            </tbody>Â·
        </table>
    </div>
    <script>
      
        var testBigCertificate =
            'MIIFCjCCA/KgAwIBAgIRAOmeRRu4pB7BKabPJNHAmpYwDQYJKoZIhvcNAQELBQAwVjELMAkGA1UEBhMCVFcxEjAQBgNVBAoMCeihjOaUv+mZojEzMDEGA1UECwwqKOa4rOippueUqCkg5pS/5bqc5ris6Kmm5oaR6K2J566h55CG5Lit5b+DMB4XDTIxMDgxMzAzMTMwNFoXDTIyMDIxMzAzMTMwNFowJTELMAkGA1UEBhMCVFcxFjAUBgNVBAoMDea4rOippuapn+mXnDEwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDHzxFAXgNxcLr8YYVfGm9Fk+bfxDXzp+Y4vgZRSZnii6s91g1rXDqEKsySuqHvj6ppafdlXYf8fwy0K8LmjCPT8w5dNWtHEkiidqaR6pk2P5lEj3wyaqlOe3dnwoDP1t7DkutRdM4XsHIml5aZL0oefJAlz5jsd44EB6un+FHDL6TXfmj40XogBUUciGXtQ4BxBgAqCsK2k5GCAjHpIzqU6xbW9ViWsqOjsqHLy9lQkj2Eq/U/D1M+SbYhpoR3jJAncTP/+u38dTJ+QVz9bGe28Ss8zP34TLdiR9zLsH5MYmQ9VGqwuEm0WsKPIi3L2qcxtS/rEDiAWzQu4JNI/RBRAgMBAAGjggICMIIB/jAfBgNVHSMEGDAWgBR3r9Blh+4dyKn2l6AlRw7JldpxqzAdBgNVHQ4EFgQUM6vAHcYDXS0Tv/4i5MhxlcxAaNswDgYDVR0PAQH/BAQDAgeAMBQGA1UdIAQNMAswCQYHYIZ2ZQADADAaBgNVHREEEzARgQ90ZXN0QGNodC5jb20udHcwTgYDVR0JBEcwRTAWBgdghnYBZAIBMQsGCWCGdgFkAwIBATAUBgdghnYBZAICMQkTB3ByaW1hcnkwFQYHYIZ2AWQCZjEKBghghnYBZYGcITCBhgYDVR0fBH8wfTBAoD6gPIY6aHR0cDovL2d0ZXN0Y2EubmF0Lmdvdi50dy9jcmwvR1Rlc3RDQTIvODg4OC0xL2NvbXBsZXRlLmNybDA5oDegNYYzaHR0cDovL2d0ZXN0Y2EubmF0Lmdvdi50dy9jcmwvR1Rlc3RDQTIvY29tcGxldGUuY3JsMCAGA1UdJQEB/wQWMBQGCCsGAQUFBwMCBggrBgEFBQcDBDB/BggrBgEFBQcBAQRzMHEwPgYIKwYBBQUHMAKGMmh0dHA6Ly9ndGVzdGNhLm5hdC5nb3YudHcvY2VydHMvSXNzdWVkVG9UaGlzQ0EucDdiMC8GCCsGAQUFBzABhiNodHRwOi8vZ3Rlc3RjYS5uYXQuZ292LnR3L09DU1Avb2NzcDANBgkqhkiG9w0BAQsFAAOCAQEAR2lP6hpDKgoMam0dN7VOjrh/qV+oIscZpqOm0yt8ayutuGrAOoT6nlseX9ZrdnceV4cB64Hy7hlrn6S3Fa/XwSDFhcIGgu0V0l2cTrohnRdfkW1ayatyG9q8gYmpNev/GSg2tveIm2ltChqAs0h9eSRJLH2psDQ6OiiyAEgGBDc58h1UwXS8adem/jsiwx85LzVyWQ2HYyM1vrxPQ0fL+b53Bow5jU3oT7SAjSwVHLve2TnlCAjvPRvReXNqrKpvWlNoXuxRBdbnjyoYFm3q0IQjAfnCqOMs5fv+C5961ozffUGPLV14cpcNQ4/0KSxx3zwi59wnMeWMK3XgUOAL9A==';
        document.getElementById('form_init_btn').addEventListener('submit', function (event) {

            event.preventDefault();
            let bRandom = [];
            let token_sn = document.getElementById('form_token_sn').token_sn.value;
            let so_pin = document.getElementById('form_so_pin').so_pin.value;
            let new_so_pin = document.getElementById('form_new_so_pin').new_so_pin.value;
            let new_user_pin = document.getElementById('form_new_user_pin').new_user_pin.value;

            var bToken_sn = undefined;
            if(token_sn.length!=0){
                bToken_sn = hexStringToArrayBuffer(token_sn);
               
            }
           
            GTIDEM_GetTokenInfo(bToken_sn).then((response) => {
                        
                if(response.statusCode==CTAP1_ERR_SUCCESS){
                    
                    bRandom = (response.rn).slice(0,8);
                    bToken_sn = response.sn;
                    console.log("RandomNumber: \n"+bufToHex(bRandom));

                }else{
                   alert(showFIDOErrorMessage(response));
                   return;
                }
            }).catch((error) => {
                alert(error)
                console.log('FAIL', error);
                return;
            });

            var AllowHostDomains=[];
         

            //AllowHostDomains = ["*.gotrustid.com","gotrustid.com.tw", "gotrustidem-dev.github.io","ctbc.com","ctbc123.com","test.ctbc.com"];
            let rpid1 = document.getElementById('form_allow_domain').allowrpid1.value;
            let rpid2 = document.getElementById('form_allow_domain').allowrpid2.value;
            let rpid3 = document.getElementById('form_allow_domain').allowrpid3.value;
            let rpid4 = document.getElementById('form_allow_domain').allowrpid4.value;
            let rpid5 = document.getElementById('form_allow_domain').allowrpid5.value;
            let rpid6 = document.getElementById('form_allow_domain').allowrpid6.value;

            
            console.log(token_sn);
            console.log(so_pin);
            console.log(new_so_pin);
            console.log(new_user_pin);
            console.log(AllowHostDomains);

            var bSOPINArray = new Uint8Array(so_pin.length);
            bSOPINArray.set(toUTF8Array(so_pin), 0);

            var bNewSOPINArray = new Uint8Array(new_so_pin.length);
            bNewSOPINArray.set(toUTF8Array(new_so_pin), 0);

            var bNewUserPINArray = new Uint8Array(new_user_pin.length);
            bNewUserPINArray.set(toUTF8Array(new_user_pin), 0);






            //let bSOPIN = new Uint8Array([0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38]);
            //let bToken_sn = new Uint8Array([0x41,0x42,0x43,0x44,0x45,0x46,0x47,0x48]);
            //let bNewSOPIN = new Uint8Array([0x71,0x72,0x73,0x74,0x75,0x76,0x77,0x78]);
            //let bNewUserPIN = new Uint8Array([0x81,0x82,0x83,0x84,0x85,0x86,0x87,0x88]);

            var para = prepareInitToken(bSOPINArray,bRandom,bToken_sn,bNewSOPINArray,bNewUserPINArray,AllowHostDomains);

            //do Token Initial

            




        });


        async function prepareInitToken(bSOPIN,bRandom,bToken_sn,bNewSOPin,bNewUserPIN,AllowHostDomains){

            var sessionKey;
            var iv;
            var macKey;

            var bEncryptedInitData;
            var bHashMacofInitData;


            sessionKey = await computingSessionKey(bSOPIN,bRandom);
            console.log(bufToHex(sessionKey));
            iv = await computingIV(bToken_sn);
            console.log(bufToHex(iv));
            macKey = await computingMacKey(bSOPIN,bRandom);
            console.log(bufToHex(macKey));

            var bHashedDomain = await convertDomainList2Hash(AllowHostDomains);

            var initData = {
                soPIN : bNewSOPin,
                userPIN: bNewUserPIN,
                allowRPID:bHashedDomain
            }
            //build init data with cbor 
            var encodedInitData = new Uint8Array(CBOR.encode(initData));
            console.log(encodedInitData);
            console.log(bufToHex(encodedInitData));



            // bEncryptedInitData = await crypto.subtle.encrypt({
            // name: "aes-cbc",
            // iv
            // }, sessionKey, encodedInitData);

            bEncryptedInitData = await window.crypto.subtle.importKey("raw",
            sessionKey,
                "aes-cbc", false, ["encrypt"])
            .then(cryptoKey=>{
                return crypto.subtle.encrypt({
                name: "aes-cbc",
                iv
                }, cryptoKey, encodedInitData);

            });
            console.log("bEncryptedInitData: \n"+bufToHex(bEncryptedInitData));

            bHashMacofInitData = await window.crypto.subtle.importKey(
                "raw", // raw format of the key - should be Uint8Array
                macKey,
                { // algorithm details
                    name: "HMAC",
                    hash: {name: "SHA-256"}
                },
                false, // export = false
                ["sign", "verify"] // what this key can do
            ).then( key => {
                return window.crypto.subtle.sign(
                    "HMAC",
                    key,
                    encodedInitData
                );
            });
            console.log("InitData HMAC: \n"+bufToHex(bHashMacofInitData));
        }
        async function computingSessionKey(so_pin,random){

              
                var sessionKey;

                var sessionKeyData = new Uint8Array(so_pin.byteLength+random.byteLength+1);
                sessionKeyData.set(so_pin, 0);
                sessionKeyData.set(random, so_pin.byteLength);
                sessionKeyData.set(new Uint8Array([0x1]),so_pin.byteLength+random.byteLength);
            
                  await window.crypto.subtle.digest(
                    "SHA-256",sessionKeyData
                )
                .then(function(key){

                    return sessionKey = new Uint8Array(key);
                });
             
                return sessionKey;


        }
        async function computingIV(bToken_sn){

            var hash; 
              await window.crypto.subtle.digest(
                    "SHA-256",bToken_sn
                ).then(function(value){
                    return hash =  new Uint8Array(value);
                });

                return hash.slice(0,16);

        }
        async function computingMacKey(so_pin,random){
            var iv;
            var MacKey;

            var macKeyData = new Uint8Array(so_pin.byteLength+random.byteLength+1);
            macKeyData.set(so_pin, 0);
            macKeyData.set(random, so_pin.byteLength);
            macKeyData.set(new Uint8Array([0x2]),so_pin.byteLength+random.byteLength);

              await window.crypto.subtle.digest(
                    "SHA-256",macKeyData
                ).then(function(key){

                    return MacKey  = new Uint8Array(key);
                });

                return MacKey;
            

        }
        async function prepareUnloukPIN(so_pin,bRandom,bToken_sn,bNewUserPIN){

            var sessionKey;
            var iv;
            var macKey;

            var bEncryptedInitData;
            var bHashMacofInitData;


            sessionKey = await computingSessionKey(so_pin,random);
            console.log(bufToHex(sessionKey));
            iv = await computingIV(bToken_sn);
            console.log(bufToHex(iv));
            macKey = await computingMacKey(so_pin,random);
            console.log(bufToHex(macKey));

            var bHashedDomain = await convertDomainList2Hash(AllowHostDomains);

            var initData = {
                userpin: bNewUserPIN
            }
            //build init data with cbor 
            var encodedInitData = new Uint8Array(CBOR.encode(initData));
            console.log(encodedInitData);
            console.log(bufToHex(encodedInitData));



            // bEncryptedInitData = await crypto.subtle.encrypt({
            // name: "aes-cbc",
            // iv
            // }, sessionKey, encodedInitData);

            bEncryptedInitData = await window.crypto.subtle.importKey("raw",
            sessionKey,
                "aes-cbc", false, ["encrypt"])
            .then(cryptoKey=>{
                return crypto.subtle.encrypt({
                name: "aes-cbc",
                iv
                }, cryptoKey, encodedInitData);

            });
            console.log("bEncryptedInitData: \n"+bufToHex(bEncryptedInitData));

            bHashMacofInitData = await window.crypto.subtle.importKey(
                "raw", // raw format of the key - should be Uint8Array
                macKey,
                { // algorithm details
                    name: "HMAC",
                    hash: {name: "SHA-256"}
                },
                false, // export = false
                ["sign", "verify"] // what this key can do
            ).then( key => {
                return window.crypto.subtle.sign(
                    "HMAC",
                    key,
                    encodedInitData
                );
            });
            console.log("InitData HMAC: \n"+bufToHex(bHashMacofInitData));





        }
        async function convertDomainList2Hash(allowRpid){


            var hashedDomainList = new Uint8Array(allowRpid.length*8);
            for (let i = 0; i < allowRpid.length; i++) { 

                var binDomain;

                //check wildcard domain
                if(allowRpid[i].indexOf('*.')>=0){
                    binDomain = toUTF8Array(allowRpid[i].substring(allowRpid[i].indexOf('*.')+2)); 
                }else{
                   binDomain = toUTF8Array(allowRpid[i]); 
                }
                 
                await window.crypto.subtle.digest(
                    "SHA-256",binDomain
                ).then(function(hashDomain){
                    hashedDomainList.set(new Uint8Array(hashDomain).slice(0,8),i*8);
                });
            }
            console.log(bufToHex(hashedDomainList));
            return hashedDomainList;

        }

    </script>

</body>

</html>